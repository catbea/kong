<template>
  <div id="map-container"></div>
</template>

<script>
import TMap from '@/utils/tMap'
import { mapGetters } from 'vuex'
import commonService from '@/services/commonService'
export default {
  data () {
    return {
      map: null,
      latLng: {
        lat: 31.28706,
        lng: 114.606628,
      },
      markList: [],
      city: '全国',
      provice: '',
      houseList: [],
      zoom: 5
    }
  },
  computed: {
    ...mapGetters(['userArea', 'userInfo'])
  },
  created() {
    if (this.userArea.latitude) {
      this.latLng = {
        lat: this.userArea.latitude,
        lng: this.userArea.longitude
      }
      this.city = this.userArea.city
    }
    this.initMap(this.latLng.lat, this.latLng.lng)
    this.getRegionTotal(1)
  },
  methods: {
    async initMap(lat, lng) {
      await TMap()
      this.map = new qq.maps.Map(document.getElementById('map-container'), {
        center: new qq.maps.LatLng(lat, lng), // 地图的中心地理坐标
        zoom: 5,
        minZoom: 3,
        maxZoom: 15,
        disableDefaultUI: true, // 禁止所有的默认控件
        scrollwheel: false,
        keyboardShortcuts: false,
        panControl: false
      })
      qq.maps.event.addListener(this.map, 'zoom_changed', () => {
        this.zoomChange(this.map.getZoom())
      })
      this.updateMark()
    },
    getCity () {
      this.latLng = this.map.getCenter()
      var latLng = new qq.maps.LatLng(this.latLng.lat, this.latLng.lng)
      geocoder.getAddress(latLng)
    },
    zoomChange (zoom) {
      this.zoom = zoom
      if (zoom <= 5) {
        this.city = '全国'
        this.getRegionTotal(1)
      } else if ( zoom > 5 && zoom <= 7) {
        if (this.provice) {
          this.city = this.provice
        }
        this.getRegionTotal(2)
      } else if (zoom > 7 && zoom <= 10) {
        this.getRegionTotal(3)
      } else {
        this.getRegionLinkers()
      }
    },
    getRegionLinkers () {
      commonService.getRegionLinkers({
        longitude: this.latLng.lng,
        latitude: this.latLng.lat
      }).then(res => {
        let arr = []
        res.forEach(el => {
          let obj = {
            latitude: el.latitude,
            level: 3,
            linkerNum: '',
            longitude: el.longitude,
            name: el.linkerName
          }
          arr.push(obj)
        })
        this.houseList = arr
        this.updateMark()
      }).catch()
    },
    getRegionTotal (level) {
      commonService.getRegionTotal({
        parentName: this.city,
        longitude: this.latLng.lng,
        latitude: this.latLng.lat,
        level: level
      }).then(res => {
        this.houseList = res
        this.updateMark()
      }).catch()
    },
    updateMark() {
      // clean 当前
      this.cleanMark()
      this.markMaker()
    },
    cleanMark() {
      while (this.markList.length > 0) {
        let shift = this.markList.shift()
        shift.setMap(null)
      }
    },
    markMaker() {
      let scaleSize = new qq.maps.Size(100, 30)
      for (let temp of this.houseList) {
        let marker = new qq.maps.Marker({
          icon: new qq.maps.MarkerImage('', null, null, null, scaleSize),
          map: this.map,
          position: new qq.maps.LatLng(temp.latitude, temp.longitude),
          decoration: new qq.maps.MarkerDecoration(`<div class="text">${temp.name}${temp.linkerNum}<span class="arrow"></span></div>`, new qq.maps.Point(0, -4))
        })
        qq.maps.event.addListener(marker, 'click', (e) => {
          let zoom = this.map.zoom
          this.latLng = e.latLng
          this.map.setCenter(new qq.maps.LatLng(e.latLng.lat, e.latLng.lng))
          if (zoom <= 5) {
            this.provice = temp.name
          } else if (zoom > 5 && zoom <= 7) {
            this.city = temp.name
          }
          this.map.setZoom(zoom + 2)
        })
        this.markList.push(marker)
      }
    }
  }
}
</script>


<style lang="less">
#map-container {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  font-size: 12px;
  color: #fff;
  .text{
    margin: auto;
    padding: 0 10px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    background-color: #007AE6;
    border-radius: 10px;
    position: relative;
    .arrow{
      position: absolute;
      left: 50%;
      width: 0; 
      height: 0;
      top: 20px;
      border-width: 5px;
      border-style: solid;
      border-color:#007AE6 transparent transparent transparent;
      transform: translateX(-50%);
    }
  }
}
</style>
